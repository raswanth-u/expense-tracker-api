name: CD Pipeline

on:
  push:
    branches: [main]
    
  # Allow manual trigger
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # JOB 1: Run CI First
  # ============================================
  ci:
    name: Run CI Pipeline
    uses: ./.github/workflows/ci.yml

  # ============================================
  # JOB 2: Build and Push Docker Image
  # ============================================
  build-and-push:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: ci
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # JOB 3: Deploy to Server
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production  # Requires manual approval in GitHub settings
    
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          version: 1.56.1
          args: --ssh
      
      - name: Verify Tailscale connection
        run: |
          echo "Tailscale status:"
          tailscale status
          echo "Testing connection to server..."
          ping -c 3 ${{ secrets.SERVER_HOST }} || echo "Ping failed, but SSH might still work"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          debug: true
          command_timeout: 30m
          script_stop: true  # ← Stop on first error
          script: |
            set -e
            set -x

            echo "=== Starting deployment at $(date) ==="
            cd /app/expense-tracker
            
            echo "=== Logging into Docker registry ==="
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull latest image
            echo "=== Pulling latest image ==="
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest 2>&1 | \
              grep -E 'Pulling|Waiting|Downloading|Extracting|Pull complete' || true
            
            # Stop old containers
            echo "=== Stopping old containers ==="
            docker compose down 2>&1 | \
              grep -E 'Stopping|Removing' || true
            
            # Start new containers
            echo "=== Starting new containers ==="
            docker compose up -d 2>&1 | \
              grep -E 'Creating|Starting|Recreating' || true

            # Wait for services to be ready
            echo "=== Waiting for services (15s) ==="
            echo "Waiting for services to start..."
            sleep 15
            
            # Health check
            # echo "=== Running health check ==="
            # curl -f https://localhost/health -k || {
            #   echo "Health check failed!"
            #   docker compose logs api
            #   exit 1
            # }

            # Progressive health check
            echo "Waiting for service to be ready..."
            for i in {1..30}; do
              echo "Health check attempt $i/30..."
              if curl -f https://localhost/health -k --max-time 5; then
                echo "✅ Service is healthy!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "❌ Health check timeout!"
                docker compose logs --tail=50 api
                exit 1
              fi
              sleep 5
            done

            # Clean up old images
            echo "=== Cleaning up old images ==="
            docker image prune -f
            
            echo "Deployment successful!"

      # - name: Deploy via SSH
      #   run: |
      #     # Setup SSH
      #     mkdir -p ~/.ssh
      #     echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
      #     chmod 600 ~/.ssh/id_rsa
      #     ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
      #     # Run deployment with real-time output
      #     ssh -v ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
      #       set -ex
      #       cd /app/expense-tracker
            
      #       echo "Logging into registry..."
      #       echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
      #       echo "Pulling image..."
      #       docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            
      #       echo "Restarting services..."
      #       docker compose down
      #       docker compose up -d
            
      #       sleep 15
            
      #       curl -f https://localhost/health -k || exit 1
            
      #       docker image prune -f
      #       echo "Done!"
      #     ENDSSH

      - name: Notify on success
        if: success()
        run: echo "✅ Deployed successfully!"

      - name: Notify on failure
        if: failure()
        run: echo "❌ Deployment failed!"
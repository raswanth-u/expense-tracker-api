# =============================================================================
# DEVELOPMENT ENVIRONMENT
# =============================================================================
# Network: expenses-app-v1_default (automatically created)
# 
# Port Mapping Strategy (to avoid conflicts with production):
#   - PostgreSQL: Host 5433 → Container 5432
#   - HTTP:       Host 8081 → Container 80
#   - HTTPS:      Host 8443 → Container 443
#
# Access URLs:
#   - API: https://localhost:8443/api/
#   - Health: https://localhost:8443/health
# =============================================================================

services:
  db:
    image: postgres:15-alpine
    restart: always
    ports:
      - "5433:5432"  # DEV: Use 5433 to avoid conflict with prod (5432)
    env_file:
      - .env
    volumes:
      - ./tracker-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U expense_admin -d expenses_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    build: .
    depends_on: 
      db:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - RUN_MIGRATIONS=true  # Auto-run migrations in dev
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  nginx:
    image: nginx:alpine
    ports:
      - "8081:80"    # DEV: Use 8081 to avoid conflict with prod (8080)
      - "8443:443"   # DEV: Use 8443 to avoid conflict with prod (443)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
